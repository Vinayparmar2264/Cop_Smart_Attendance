{% extends "layout.html" %}
{% block title %}Add New Member{% endblock %}

{% block content %}
<div class="px-4">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Enroll New Team Member</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white p-6 rounded-lg shadow-md">
            <form id="enroll-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">1. Select Team</label>
                    <select id="team-select" name="team" class="w-full p-2 border border-gray-300 rounded-lg" required>
                        <option value="" disabled selected>Choose a team...</option>
                        {% for team in teams %}
                        <option value="{{ team }}">{{ team }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">2. Core Details</label>
                    <fieldset id="member-details-fieldset">
                        <input type="text" name="name" class="w-full p-2 mb-2 border border-gray-300 rounded-lg" placeholder="Member Name" required>
                        <input type="text" name="id" id="enroll-id-input" class="w-full p-2 mb-2 border border-gray-300 rounded-lg" placeholder="Unique Enrollment ID" required>
                        <input type="text" name="contact" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Contact Number" required>
                    </fieldset>
                </div>
            </form>

            <div id="enrollment-controls">
                <button type="button" id="start-camera-btn" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-300 disabled:bg-gray-400" disabled>
                    1. Verify Details & Start Camera
                </button>
                <div id="capture-controls" class="hidden grid grid-cols-2 gap-4 mt-4">
                    <button type="button" id="capture-btn" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600">
                        2. Capture Images
                    </button>
                    <button type="button" id="cancel-camera-btn" class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">
                        Cancel
                    </button>
                </div>
                <div id="update-confirmation-section" class="hidden mt-4 p-4 border-t border-orange-300 bg-orange-50 rounded-lg">
                    <p id="update-message" class="text-center font-semibold text-orange-700 mb-4"></p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <button type="button" id="confirm-update-btn" class="w-full bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600">✅ Yes, Update & Recapture</button>
                        <button type="button" id="cancel-update-btn" class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">❌ No, Cancel</button>
                    </div>
                </div>
            </div>

            <div id="post-capture-controls" class="hidden mt-4 p-4 border-t">
                 <p id="post-capture-message" class="text-center font-semibold text-green-600 mb-4">Enrollment Complete!</p>
                 <div class="grid grid-cols-1 gap-3">
                     <button type="button" id="train-now-btn" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600">Train Model Now</button>
                     <button type="button" id="enroll-another-btn" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">Enroll Another Member</button>
                     <button type="button" id="delete-retry-btn" class="w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">Delete Last Enrollment & Retry</button>
                 </div>
            </div>

            <div id="independent-train-section" class="pt-4 mt-4 border-t">
                <button type="button" id="train-model-btn" class="w-full bg-purple-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-600 transition duration-300 disabled:bg-gray-400" disabled>
                    Train Model for Selected Team
                </button>
            </div>

            <p id="enroll-status" class="mt-4 text-center font-semibold"></p>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center">
            <h3 class="text-lg font-semibold mb-4">Live Camera Feed</h3>
            <img id="video-feed" src="https://placehold.co/640x480/E2E8F0/A0AEC0?text=Camera+Off" class="rounded-lg border border-gray-300 w-full" alt="Camera Feed">
        </div>
    </div>
</div>

<div id="details-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-2xl leading-6 font-bold text-gray-900">3. Additional Employee Data</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500 mb-4">This information is optional. You can fill it in now or update it later from the team dashboard.</p>
                <form id="additional-details-form" class="text-left space-y-4 max-h-[50vh] overflow-y-auto pr-2">
                    </form>
            </div>
            <div class="items-center px-4 py-3 border-t mt-4">
                <button id="save-details-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                    Save Details & Finish
                </button>
                <button id="skip-details-btn" class="mt-2 px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Skip for Now
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- DOM Element Selection ---
    const enrollForm = document.getElementById('enroll-form');
    const memberDetailsFieldset = document.getElementById('member-details-fieldset');
    const teamSelect = document.getElementById('team-select');
    const enrollIdInput = document.getElementById('enroll-id-input');
    const startCameraBtn = document.getElementById('start-camera-btn');
    const captureControls = document.getElementById('capture-controls');
    const captureBtn = document.getElementById('capture-btn');
    const cancelCameraBtn = document.getElementById('cancel-camera-btn');
    const postCaptureControls = document.getElementById('post-capture-controls');
    const postCaptureMessage = document.getElementById('post-capture-message');
    const trainNowBtn = document.getElementById('train-now-btn');
    const enrollAnotherBtn = document.getElementById('enroll-another-btn');
    const deleteRetryBtn = document.getElementById('delete-retry-btn');
    const independentTrainSection = document.getElementById('independent-train-section');
    const trainModelBtn = document.getElementById('train-model-btn');
    const statusP = document.getElementById('enroll-status');
    const videoFeed = document.getElementById('video-feed');
    const updateConfirmationSection = document.getElementById('update-confirmation-section');
    const updateMessage = document.getElementById('update-message');
    const confirmUpdateBtn = document.getElementById('confirm-update-btn');
    const cancelUpdateBtn = document.getElementById('cancel-update-btn');
    const placeholderImg = "https://placehold.co/640x480/E2E8F0/A0AEC0?text=Camera+Off";
    const detailsModal = document.getElementById('details-modal');
    const additionalDetailsForm = document.getElementById('additional-details-form');
    const saveDetailsBtn = document.getElementById('save-details-btn');
    const skipDetailsBtn = document.getElementById('skip-details-btn');
    const enrollmentControls = document.getElementById('enrollment-controls');

    // --- State Management ---
    let lastEnrollmentId = null;
    let lastTeamName = null;

    function resetUI() {
        detailsModal.classList.add('hidden');
        enrollmentControls.classList.remove('hidden');
        statusP.textContent = '';
        statusP.className = 'mt-4 text-center font-semibold';
        memberDetailsFieldset.disabled = false;
        teamSelect.disabled = false;
        enrollForm.reset();
        startCameraBtn.classList.remove('hidden');
        startCameraBtn.disabled = true;
        captureControls.classList.add('hidden');
        postCaptureControls.classList.add('hidden');
        updateConfirmationSection.classList.add('hidden');
        independentTrainSection.classList.remove('hidden');
        videoFeed.src = placeholderImg;
        lastEnrollmentId = null;
        lastTeamName = null;
        trainModelBtn.disabled = !teamSelect.value;
    }

    function setStatus(text, type = 'info') {
        statusP.textContent = text;
        const colorClasses = {
            info: 'text-blue-600',
            success: 'text-green-600',
            error: 'text-red-600'
        };
        statusP.className = `mt-4 text-center font-semibold ${colorClasses[type]}`;
    }

    async function showAdditionalDetailsForm() {
        const teamName = teamSelect.value;
        try {
            const response = await fetch(`/api/get_team_fields/${teamName}`);
            if (!response.ok) throw new Error('Network response was not ok');
            const fields = await response.json();

            additionalDetailsForm.innerHTML = '';
            fields.forEach(field => {
                if (field.editable) {
                    const div = document.createElement('div');
                    const label = document.createElement('label');
                    label.className = 'block text-sm font-medium text-gray-700';
                    label.textContent = field.label;
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.name = field.key;
                    input.placeholder = `Enter ${field.label}...`;
                    input.className = 'w-full p-2 mt-1 border border-gray-300 rounded-lg';
                    div.appendChild(label);
                    div.appendChild(input);
                    additionalDetailsForm.appendChild(div);
                }
            });
            enrollmentControls.classList.add('hidden');
            independentTrainSection.classList.add('hidden');
            detailsModal.classList.remove('hidden');
        } catch (error) {
            console.error("Failed to fetch team fields:", error);
            setStatus("Could not load additional fields. Skipping this step.", "error");
            detailsModal.classList.add('hidden');
            postCaptureControls.classList.remove('hidden');
        }
    }

    async function handleCapture(isUpdate = false) {
        captureControls.classList.add('hidden');
        updateConfirmationSection.classList.add('hidden');
        setStatus(isUpdate ? 'Updating and recapturing... Please hold still.' : 'Capturing images... Please hold still.', 'info');
        captureBtn.disabled = true;

        memberDetailsFieldset.disabled = false;
        teamSelect.disabled = false;
        const formData = new FormData(enrollForm);
        if (isUpdate) {
            formData.append('update_mode', 'true');
        }
        lastEnrollmentId = enrollIdInput.value;
        lastTeamName = teamSelect.value;
        memberDetailsFieldset.disabled = true;
        teamSelect.disabled = true;

        try {
            const response = await fetch('/api/enroll_capture', { method: 'POST', body: formData });
            const result = await response.json();
            videoFeed.src = placeholderImg; // Turn off camera after capture attempt

            if (result.status === 'success') {
                setStatus('Face capture successful. Please provide additional details.', 'success');
                // Hide the delete button for an "update" operation, show it for a new one.
                deleteRetryBtn.style.display = isUpdate ? 'none' : 'block';
                await showAdditionalDetailsForm();
            } else if (result.status === 'exists') {
                updateMessage.textContent = result.message;
                updateConfirmationSection.classList.remove('hidden');
                setStatus('Action Required: Enrollment ID already exists.', 'info');
            } else {
                setStatus(`Error: ${result.message}`, 'error');
                // Give user a chance to see the error, then reset.
                setTimeout(resetUI, 4000);
            }
        } catch (error) {
            console.error('Capture API call failed:', error);
            setStatus('An unexpected error occurred. Check console for details.', 'error');
        } finally {
            captureBtn.disabled = false;
        }
    }

    // --- Event Listeners ---
    enrollForm.addEventListener('input', () => {
        startCameraBtn.disabled = !enrollForm.checkValidity();
    });

    teamSelect.addEventListener('change', () => {
        trainModelBtn.disabled = !teamSelect.value;
    });

    startCameraBtn.addEventListener('click', () => {
        if (!enrollForm.checkValidity()) {
            setStatus('Please fill out all member details first.', 'error');
            return;
        }
        memberDetailsFieldset.disabled = true;
        teamSelect.disabled = true;
        videoFeed.src = '/video_feed_enroll';
        startCameraBtn.classList.add('hidden');
        captureControls.classList.remove('hidden');
        independentTrainSection.classList.add('hidden');
        setStatus('Camera active. Position face and click Capture.', 'info');
    });

    captureBtn.addEventListener('click', () => handleCapture(false));
    confirmUpdateBtn.addEventListener('click', () => handleCapture(true));
    cancelUpdateBtn.addEventListener('click', resetUI);
    cancelCameraBtn.addEventListener('click', resetUI);

    saveDetailsBtn.addEventListener('click', async () => {
        const formData = new FormData(additionalDetailsForm);
        const additionalData = Object.fromEntries(formData.entries());
        const payload = {
            team_name: lastTeamName,
            enrollment_id: lastEnrollmentId,
            additional_data: additionalData
        };

        const response = await fetch('/api/update_member_details', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const result = await response.json();

        if (result.status === 'success') {
            setStatus('Enrollment complete! All details saved.', 'success');
            postCaptureMessage.textContent = 'Enrollment Complete! All details saved.';
        } else {
            setStatus(`Error saving details: ${result.message}`, 'error');
            postCaptureMessage.textContent = 'Face data saved, but additional details failed to save.';
        }
        detailsModal.classList.add('hidden');
        postCaptureControls.classList.remove('hidden');
    });

    skipDetailsBtn.addEventListener('click', () => {
        detailsModal.classList.add('hidden');
        setStatus('Additional details skipped. Enrollment is complete.', 'info');
        postCaptureMessage.textContent = 'Face data saved. You can add more details later.';
        postCaptureControls.classList.remove('hidden');
    });

    trainNowBtn.addEventListener('click', () => {
        postCaptureControls.classList.add('hidden');
        trainModelBtn.click();
    });

    enrollAnotherBtn.addEventListener('click', resetUI);

    deleteRetryBtn.addEventListener('click', async () => {
        if (!lastEnrollmentId || !lastTeamName) {
            alert('No recent enrollment attempt to delete.');
            return;
        }
        if (confirm(`Are you sure you want to PERMANENTLY delete the new enrollment for ID: ${lastEnrollmentId}? This cannot be undone.`)) {
            setStatus('Deleting last enrollment...', 'info');
            const response = await fetch('/api/delete_enrollment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ team: lastTeamName, id: lastEnrollmentId })
            });
            const result = await response.json();
            alert(result.message);
            if (result.status === 'success') {
                resetUI();
            } else {
                setStatus(result.message, 'error');
            }
        }
    });

    trainModelBtn.addEventListener('click', async () => {
        const teamName = teamSelect.value;
        if (!teamName) {
            alert('Please select a team to train.');
            return;
        }
        trainModelBtn.disabled = true;
        startCameraBtn.disabled = true;
        setStatus(`Training model for ${teamName}... This may take a moment.`, 'info');

        const response = await fetch('/api/train_model', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ team: teamName })
        });
        const result = await response.json();
        setStatus(result.message, result.status === 'success' ? 'success' : 'error');
        setTimeout(() => {
            resetUI();
        }, 3000);
    });

    document.addEventListener('DOMContentLoaded', resetUI);
</script>
{% endblock %}

